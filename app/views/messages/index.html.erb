<div class="container top100 brm10per">
  <div class="msg-contents">
    <% user_signed_in? ? talkwith = @local : talkwith = @user %>
    <div class="room_box">
      <h1><%= gravatar_for(talkwith, size:50) %> <%= talkwith.prefecture.name if talkwith == @local %><%= talkwith.name %></h1>
    </div>
    <div class="allmsg_area">
      <% user_signed_in? ? current_account = current_user : current_account = current_local %>
      <% @messages.each do |message| %>
        <% unless message.sender_type == current_account.class.to_s %>
          <div class="msg_item with_item">
            <div class="sender_icon"><%= gravatar_for(talkwith, size:40) %></div>
            <div class="msgtxt">
              <p>カテゴリ：<%= message.category %></p>
              <div class="from_talkingwith">
                <p><%= message.content %></p>
                <p><%= link_to '添付ファイル', rails_blob_path(message.pdf, disposition: "attachment"), style: 'overflow-wrap: break-word;' if message.pdf.attached? %></p>
              </div>
              <div class="message_file_area txt-left">
              <% if message.photo.attached? %>
                  <%= link_to url_for(message.photo) do %>
                  <%= image_tag message.photo%>
                <% end %>
              <% end %>
              </div>
              <p><%= time_ago_in_words(message.created_at) %>前</p>
            </div>
          </div>
        <% else %>
          <div class="msg_item  my_item">
            <div class="msgtxt">
              <p class="txt-right">カテゴリ：<%= message.category %></p>
              <div class="from_me">
                <p><%= message.content %></p>
                <p><%= link_to '添付ファイル', rails_blob_path(message.pdf, disposition: "attachment"), style: 'overflow-wrap: break-word;' if message.pdf.attached? %></p>
              </div>
              <div class="message_file_area txt-right">
                <% if message.photo.attached? %>
                  <%= link_to url_for(message.photo) do %>
                  <%= image_tag message.photo%>
                  <% end %>
                <% end %>
              </div>
              <p class="txt-right"><%= time_ago_in_words(message.created_at) %>前 | <%= link_to '削除', message, method: :delete, data: {confirm: '送信したメッセージを削除しますか'} %></p>
            </div>
            <div class="me_icon"><%= gravatar_for(current_account, size:40) %></div>
          </div>
        <% end %>
      <% end %>
    </div>
    <div class="msgform_area">
      <%= form_with(model: [@talkroom, @message], local: true) do |f| %>
        <%= render "shared/error_messages", object: f.object %>
        <%= f.hidden_field :talkroom_id, value: @talkroom.id %>

        <div class="flex_wrap">
          <div class="msgclips">
            <%= f.label :pdf do %>
              <i class="fas fa-paperclip msg_btn"></i>
              <%= f.file_field :pdf, style: 'display:none', accept: 'application/pdf' %>
            <% end %>
            <%=f.label :photo do %>
              <i class="far fa-image msg_btn"></i>
              <%= f.file_field :photo, style: 'display: none', accept: 'image/jpeg,image/gif,image/png,image/jpg' %>
            <% end %>
          </div>

          <div class="msgform">
            <div class="mb-3" style="margin-bottom: 0.5em">
              <%= f.select :category, [["返信"],["資料請求したい"],["質問がある"],["移住の相談をしたい"],["直接話を聞いてみたい"],["その他"]], {prompt: "カテゴリを選択してください"}, {class: 'form-select'} %> *必須
            </div>
            <div class="mb-3">
              <%= f.text_area :content, class: 'form-control' %>
            </div>
          </div>

          <%= f.submit "送信する", class: "green_btn" %>
        </div>
        <p id="photo_name"></p>
        <p id="file_name"></p>
      <% end %>
    </div>
  </div>
</div>

<script type="text/javascript">
  $("#message_photo").bind("change", function() {
    var selected_image = this.files[0];
    var size_in_megabytes = this.files[0].size/1024/1024;
    if (size_in_megabytes > 5) {
      alert("Maximum file size is 5MB. Please choose a smaller file.");
      $("#message_photo").val("");
    }
    else {
      document.getElementById('photo_name').innerHTML = "添付画像：" + selected_image.name;
    }
  });
  $("#message_pdf").bind("change", function() {
    var selected_file = this.files[0];
    var size_in_megabytes = this.files[0].size/1024/1024;
    if (size_in_megabytes > 5) {
      alert("Maximum file size is 5MB. Please choose a smaller file.");
      $("#message_pdf").val("");
    }
    else {
      document.getElementById('file_name').innerHTML = "添付ファイル：" + selected_file.name;
    }
  });
</script>